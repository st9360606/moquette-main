# 设计目的
MQTT（Message Queuing Telemetry Transport）是一种轻量级、灵活且开放的消息传输协议，最初设计用于受限的设备和低带宽、不稳定的网络环境中。其设计目的包括：

* 轻量级通信：设计用于 IoT 设备和资源受限的环境，保持通信协议简洁高效。
* 实时性：支持实时数据传输，能够快速、可靠地传递消息。
* 强大的发布-订阅机制：采用发布-订阅模式，使得设备之间能够轻松地发送和接收消息。
* 可靠性：提供多种 Quality of Service（QoS）级别，确保消息传输的可靠性和一致性。

## 优势
MQTT 具有多个优势，使其在 IoT 和其他领域中得到广泛应用：
* 轻量级：协议本身简单、轻量，适用于资源受限的设备。
* 低开销：协议开销小，减少网络流量和能耗。
* 灵活性：支持多种 QoS 级别，适应不同应用场景的需求。
* 可靠性：确保消息传输的可靠性和顺序性。
* 易于实现：拥有丰富的开源实现，易于在各种平台和语言中实现。

## 适用场景
MQTT 在许多场景中被广泛使用，特别是在以下情况下：

* 物联网（IoT）：连接和管理 IoT 设备，监测和控制传感器数据。
* 实时监控：传输实时数据、监控系统和设备状态。
* 远程控制：通过发布-订阅模式实现远程控制和命令传输。
* 低带宽环境：在带宽受限的网络环境中，如远程地区、移动网络等。

总的来说，MQTT 由于其轻量级、可靠性和实时性等特点，在 IoT、实时监控和远程控制等领域得到广泛应用。

举例来说，类似于 Line 聊天室这样的应用可以使用 MQTT over WebSocket 来实现实时通信。
客户端可以通过 WebSocket 连接到服务器，然后在这个连接上使用 MQTT 协议发送和接收消息。
这种方式使得消息传输更加轻量级、快速且实时，适用于需要即时通讯的应用场景。



## MQTT 消息类型：
###MQTT（Message Queuing Telemetry Transport）
是一种轻量级的、发布/订阅模式的消息传输协议。 它定义了多种消息类型，每种类型用于不同的通信场景和QoS级别。以下是MQTT中常见的消息类型：

###CONNECT
用于建立客户端与代理（broker）之间的连接。客户端向代理发送CONNECT消息以建立会话并设置相关参数，例如客户端ID、遗嘱消息、保持活动时间等。

###CONNACK
CONNACK是对CONNECT消息的响应，确认客户端是否成功连接到代理。它包含连接返回码，表示连接是否成功建立。

###PUBLISH
PUBLISH消息用于将数据发布到指定主题。它包含主题名和消息内容，并被发送到代理，然后代理将其分发给订阅了该主题的客户端。

###PUBACK, PUBREC, PUBREL, PUBCOMP
这些消息用于QoS级别1和2的消息发布确认机制。客户端发送PUBLISH消息，代理收到后会发送PUBACK（QoS 1）或PUBREC（QoS 2），表示已收到。接着客户端发送PUBREL（QoS 2），最后代理发送PUBCOMP（QoS 2），完成确认机制。

###SUBSCRIBE
用于订阅一个或多个主题。客户端发送SUBSCRIBE消息，并指定订阅主题及其QoS级别。代理收到后开始向客户端发送相应主题的消息。

###SUBACK
SUBACK是对SUBSCRIBE消息的响应，确认代理是否成功接受了订阅请求，并指明了每个订阅主题的QoS级别。

###UNSUBSCRIBE
用于取消订阅一个或多个主题。客户端发送UNSUBSCRIBE消息，代理确认后停止向客户端发送这些主题的消息。

###UNSUBACK
UNSUBACK是对UNSUBSCRIBE消息的响应，表示代理已成功处理取消订阅请求。

###PINGREQ, PINGRESP
PINGREQ消息用于客户端向代理发送心跳请求，以确认连接状态。PINGRESP是对PINGREQ的响应，表示连接正常。

###DISCONNECT
客户端发送DISCONNECT消息以正常关闭连接。

这些消息类型构成了MQTT协议的核心，并通过它们支持了各种发布/订阅的通信模式以及不同级别的消息传递保证。



## MQTT 的质量服务等级（Quality of Service, QoS）

定义了消息传递的级别，它影响了消息传递的可靠性和保证程度。MQTT支持三种不同的QoS级别：0、1 和 2。这些级别主要影响了消息传递时的可靠性和开销。

### QoS 0（最多一次）：
也称为“最多一次交付”，消息发布者发送一次消息，然后不再关心消息是否被成功接收。
传递是尽力而为的方式，消息可能会丢失或重复。这种级别的传递是最快速和最低开销的，但可靠性最低。

### QoS 1（最少一次）：
确保消息至少传递一次，但可能会重复传递。
消息发布者发送一条消息，接收者必须确认收到消息。如果没有确认，发布者会重发消息。这种级别比QoS 0更可靠，但会引入一些重复传递的可能性。

### QoS 2（只有一次）：
提供最高级别的消息传递保证，确保每条消息仅传递一次。
消息发布者发送一条消息，接收者必须确认收到消息，并且发布者和接收者会进行一系列握手以确保只传递一次。
这是最安全可靠的级别，但也是最慢且开销最大的。

### 选择合适的QoS级别取决于应用程序的需求：
如果应用程序可以容忍偶尔丢失的消息，并希望最小化延迟和网络开销，则可以选择QoS 0。
如果需要确保至少传递一次消息但可以接受偶尔的重复传递，则选择QoS 1。
如果需要确保每条消息只传递一次，并且不希望有重复的消息，则选择QoS 2。


### 建立 MQTT 连接与认证：
#### 建立 MQTT 对象：使用 MQTT 客户端库，创建一个 MQTT 对象。
* 设置连接信息：通过设置 MQTT 对象的参数，包括 Broker 的地址、协议、端口等。
* 建立连接：使用客户端库提供的方法连接到 MQTT Broker。

#### 进行认证：
* 身份验证：通过用户名和密码验证身份。在 MQTT 中，可以设置用户名和密码进行基本身份验证。
* TLS/SSL 安全设置：为了提高安全性，可以使用 TLS/SSL 协议来加密通信。这涉及加载证书和设置安全协议。

## MQTT Broker：
### 角色：
消息中介者：Broker是一个中介服务器，负责接收发布的消息，并将其传递给订阅了相应主题的客户端。

### 功能：
消息路由：根据发布的消息主题，将消息路由给订阅了相同主题的客户端。
消息存储：在某些情况下，Broker可能会存储消息，以便在客户端离线时传递未接收的消息。
QoS管理：处理不同的质量服务等级（QoS），确保消息的适当交付。
客户端管理：管理客户端连接、订阅和取消订阅请求。

## MQTT 客户端(Publisher & Subscriber)：
### 角色：
消息发布者：客户端可以发布消息到Broker，指定一个或多个主题。
消息订阅者：客户端可以订阅一个或多个主题以接收相应的消息。

### 功能：
发布消息：向Broker发送消息，指定一个或多个主题以及消息内容。
订阅主题：向Broker发送订阅请求，以接收特定主题的消息。
处理接收消息：处理从Broker接收到的消息，根据订阅的主题进行相应的处理。



## 如何使用 MQTT 客户端进行通信和交互：
###1. 客户端连接：
- 使用MQTT客户端库创建一个客户端实例。
- 指定连接的Broker地址、客户端ID和其他连接参数。
- 使用客户端实例连接到Broker。
###2. 发布消息：
- 使用客户端实例发布消息到指定的主题。
###3. 订阅消息：
- 使用客户端实例订阅一个或多个主题，以便接收相关消息。
###4. 处理接收到的消息：
- 客户端通过订阅的主题接收从Broker传递过来的消息。
- 对接收到的消息进行处理或相应的操作。
###5. 断开连接：
- 在完成通信后，客户端通过调用相应的方法与Broker断开连接。

MQTT Broker和客户端的交互是通过发布和订阅消息来实现的，这种模型提供了灵活的消息传递机制，
使得设备或应用程序能够通过Broker进行高效的通信和数据交换。





## MQTT在不同版本中有一些显著的变化和增强功能，其中两个主要版本是 MQTT 3.1.1 和 MQTT 5.0。

### MQTT 3.1.1：
###1. QoS（质量服务等级）：
####提供三种QoS级别：0、1和2。
- ####0级QoS：最多一次传递，消息可能会丢失。
- ####1级QoS：至少一次传递，确保消息到达但可能出现重复。
- ####2级QoS：恰好一次传递，确保消息只传递一次。

###2.保留消息：
- ####Broker可以保留最新发布的消息，新订阅者连接后可以立即接收到最新的保留消息。

###3.遗嘱消息（Will Message）：
- ####客户端可以设置遗嘱消息，在意外断开连接时自动发布遗嘱消息给Broker。

###4.Session和Clean Session：
- ####客户端可以选择使用Session保留连接状态，或者在断开连接后清除状态信息。

## MQTT 5.0：
### MQTT 5.0引入了更多的新特性和改进：
### 1.Session Expiry Interval：
- #### 允许客户端设置Session的持续时间，即使断开连接，Broker也可以在一段时间后清除Session。

### 2.遗嘱消息的增强：
- #### 提供更多遗嘱消息的控制选项，包括遗嘱消息的延迟发布和消息遗嘱的重写。

### 3.共享订阅：
- #### 引入了共享订阅机制，允许多个客户端共同订阅相同的主题。

### 4.更多的QoS等级：
- #### 引入了QoS 2.5级，提供更多的消息交付选项。

### 5.属性（Properties）：
- #### 引入消息属性机制，允许消息携带一系列的属性信息。

### 6.流控制：
- #### 支持在客户端和Broker之间实现流控制，以便更好地管理消息传输。

### 7.错误处理：
- #### 改进了错误代码和错误信息的处理，使得更容易理解和诊断连接问题。


#### MQTT 5.0相对于3.1.1版本引入了更多的功能和灵活性，包括消息属性、共享订阅、更多的QoS级别以及改进的错误处理，这些功能使得MQTT协议更适用于复杂的通信需求和场景。





